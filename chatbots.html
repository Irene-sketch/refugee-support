<!DOCTYPE html>
<html lang="en">
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Refugee Support Chatbot</title>
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background-color:#d5f5dc;
                margin: 0;
                padding: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
            }
    
            .chat-container {
                width: 90%;
                max-width: 500px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
    
            .chat-header {
                background-color: #f29c47;
                color: white;
                padding: 20px;
                text-align: center;
                font-size: 1.2em;
                font-weight: 600;
            }
    
            .chatbox {
                flex-grow: 1;
                overflow-y: auto;
                padding: 20px;
                display: flex;
                flex-direction: column;
            }
    
            .chat-message {
                padding: 12px 18px;
                margin-bottom: 10px;
                border-radius: 20px;
                max-width: 80%;
                clear: both;
                line-height: 1.6;
            }
    
            .user-message {
                background-color: #f6a249;
                align-self: flex-end;
                color: #333;
            }
    
            .bot-message {
                background-color: #d5f5dc;
                align-self: flex-start;
                color: #333;
            }
    
            .input-container {
                display: flex;
                padding: 15px;
                border-top: 1px solid #eee;
            }
    
            input {
                flex-grow: 1;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 25px;
                font-size: 16px;
                margin-right: 10px;
            }
    
            button {
                padding: 12px 20px;
                background: #f6a249;
                color: white;
                border: none;
                border-radius: 25px;
                cursor: pointer;
                font-size: 16px;
                transition: background-color 0.3s ease;
            }
    
            button:hover {
                background: #035f03;
            }
        </style>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    </head>
    <body>
        <div class="chat-container">
            <div class="chat-header">Refugee Support Chatbot</div>
            <div id="chatbox" class="chatbox"></div>
            <div class="input-container">
                <input type="text" id="userInput" placeholder="Ask me anything...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
        <script>
            // Firebase Configuration (Replace with your actual config)
            const firebaseConfig = {
            apiKey: "AIzaSyCcoozZQWTAI_1g_E0tjlXk6dateBJCeU0",
            authDomain: "refugee-support-26a83.firebaseapp.com",
            projectId: "refugee-support-26a83",
            storageBucket: "refugee-support-26a83.firebasestorage.app",
            messagingSenderId: "476368770087",
            appId: "1:476368770087:web:8d7e98f5220d7e572a6a02"
            };
    
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            const API_KEY = "AIzaSyBGjm7iZ1l6wFffs5BtHy0ruHWtuBQB7Yw"; // Replace with your actual Gemini API Key
    
            let conversationHistory = [];
            let user;
    
            auth.onAuthStateChanged(async (currentUser) => {
                if (currentUser) {
                    user = currentUser;
                    await loadChatHistory();
                } else {
                    alert("Please log in to use the chatbot.");
                    window.location.href = "login.html";
                }
            });
    
            async function loadChatHistory() {
                if (!user) return;
                const chatbox = document.getElementById("chatbox");
                chatbox.innerHTML = "";
                conversationHistory = [];
    
                try {
                    const chatDoc = await db.collection("chats").doc(user.uid).get();
                    if (chatDoc.exists) {
                        const data = chatDoc.data();
                        conversationHistory = data.history || [];
                        conversationHistory.forEach(message => {
                            const className = message.role === "user" ? "user-message" : "bot-message";
                            const sender = message.role === "user" ? "You" : "Bot";
                            chatbox.innerHTML += `<div class="chat-message ${className}"><b>${sender}:</b> ${message.parts[0].text}</div>`;
                        });
                        chatbox.scrollTop = chatbox.scrollHeight;
                    }
                } catch (error) {
                    console.error("Error loading chat history:", error);
                    chatbox.innerHTML += `<div class="chat-message bot-message"><b>Bot:</b> Failed to load chat history.</div>`;
                }
            }
    
            async function sendMessage() {
                if (!user) return;
    
                let userMessage = document.getElementById("userInput").value.trim();
                if (!userMessage) return;
    
                let chatbox = document.getElementById("chatbox");
                chatbox.innerHTML += `<div class="chat-message user-message"><b>You:</b> ${userMessage}</div>`;
                document.getElementById("userInput").value = "";
    
                conversationHistory.push({ role: "user", parts: [{ text: userMessage }] });
    
                try {
                    let response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${API_KEY}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: conversationHistory })
                    });
                
    
                    let data = await response.json();
                    let botReply = data?.candidates?.[0]?.content?.parts?.[0]?.text || "I'm sorry, I don't understand.";
    
                    chatbox.innerHTML += `<div class="chat-message bot-message"><b>Bot:</b> ${botReply}</div>`;
                    conversationHistory.push({ role: "model", parts: [{ text: botReply }] });
    
                    await db.collection("chats").doc(user.uid).set({ history: conversationHistory });
                    chatbox.scrollTop = chatbox.scrollHeight;
    
                } catch (error) {
                    console.error("Error:", error);
                    chatbox.innerHTML += `<div class="chat-message bot-message"><b>Bot:</b> Oops! Something went wrong.</div>`;
                }
            }
        </script>
    </body>
    </html>